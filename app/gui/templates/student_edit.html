{% extends "base.html" %}
{% block content %}

  {% if student %}
    <div class="card">
      <h1 style="margin:0 0 8px;">Edit Student</h1>
      <p style="margin:0; color: var(--muted);">
        Update student information and save changes.
      </p>
      <div class="actions" style="margin-top: 12px;">
        <a class="btn" href="/students/{{ student.id_student }}">← Back to detail</a>
        <a class="btn" href="/students">Students</a>
      </div>
    </div>

    <div class="card" style="margin-top: 14px;">
      <form id="editForm">
        <div class="grid" style="margin-top: 0;">
          <div>
            <div class="field">
              <label>First name</label>
              <input type="text" name="first_name" value="{{ student.first_name }}" required />
            </div>

            <div class="field">
              <label>Last name</label>
              <input type="text" name="last_name" value="{{ student.last_name }}" required />
            </div>

            <div class="field">
              <label>Birth date</label>
              <input type="date" name="birth_date" value="{{ student.birth_date or '' }}" />
            </div>
          </div>

          <div>
            <div class="field">
              <label>Class ID</label>
              <input type="number" name="class_id" value="{{ student.class_id or '' }}" />
            </div>

            <div class="field">
              <label>Status</label>
              <select name="is_active_select">
                <option value="true" {% if student.is_active %}selected{% endif %}>Active</option>
                <option value="false" {% if not student.is_active %}selected{% endif %}>Inactive</option>
              </select>
            </div>

            <div class="alert" style="margin-top: 6px;">
              <b>Tip:</b> If Class ID does not exist, DB may reject the update (FK constraint).
            </div>
          </div>
        </div>

        <div class="actions" style="margin-top: 14px;">
          <button class="btn btn-primary" type="submit">Save changes</button>
        </div>

        <div id="resultBox" class="alert alert-error" style="display:none; margin-top:12px;">
          <pre id="result" style="white-space: pre-wrap; margin:0;"></pre>
        </div>
      </form>
    </div>

    <script>
      document.getElementById("editForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const box = document.getElementById("resultBox");
        const out = document.getElementById("result");
        box.style.display = "none";
        out.textContent = "";

        const form = e.target;
        const classVal = form.class_id.value ? parseInt(form.class_id.value, 10) : null;

        const isActive = (form.is_active_select.value === "true");

        const data = {
          first_name: form.first_name.value,
          last_name: form.last_name.value,
          birth_date: form.birth_date.value ? form.birth_date.value : null,
          class_id: Number.isFinite(classVal) ? classVal : null,
          is_active: isActive
        };

        try {
          const resp = await fetch("/api/students/{{ student.id_student }}", {
            method: "PUT",
            headers: { "Content-Type": "application/json", "accept": "application/json" },
            body: JSON.stringify(data)
          });

          const text = await resp.text();

          if (resp.ok) {
            window.location.href = "/students/{{ student.id_student }}";
            return;
          }

          box.style.display = "block";
          out.textContent = "Update failed (" + resp.status + "): " + text;
        } catch (err) {
          box.style.display = "block";
          out.textContent = "Update failed: " + err;
        }
      });
    </script>

  {% else %}
    <div class="card">
      <h1 style="margin:0 0 8px;">Edit Student</h1>
      <p style="margin:0; color: var(--muted);">Student not found.</p>
      <div class="actions" style="margin-top: 12px;">
        <a class="btn" href="/students">← Back to list</a>
      </div>
    </div>
  {% endif %}

{% endblock %}
