{% extends "base.html" %}
{% block content %}

  <div class="card">
    <h1 style="margin:0 0 8px;">Teacher ↔ Subject</h1>
    <p style="margin:0; color: var(--muted);">
      Manage M:N assignments between teachers and subjects.
    </p>

    <form method="get" action="/teacher-subject" style="margin-top: 12px;">
      <div class="actions">
        <div class="field" style="min-width: 280px; margin:0;">
          <label>Select teacher</label>
          <select name="teacher_id" required>
            <option value="">— choose —</option>
            {% for t in teachers %}
              <option value="{{ t.id_teacher }}" {% if selected_teacher_id and t.id_teacher == selected_teacher_id %}selected{% endif %}>
                {{ t.id_teacher }} – {{ t.first_name }} {{ t.last_name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <button class="btn btn-primary" type="submit">Load</button>
      </div>
    </form>
  </div>

  {% if selected_teacher %}
    <div class="grid" style="margin-top: 14px;">
      <div class="card">
        <h3>Assigned subjects</h3>
        <p style="margin:0 0 10px; color: var(--muted);">
          Teacher: <b>{{ selected_teacher.first_name }} {{ selected_teacher.last_name }}</b> (ID {{ selected_teacher.id_teacher }})
        </p>

        {% if assigned and assigned|length > 0 %}
          <table class="table">
            <thead>
              <tr>
                <th style="width: 80px;">ID</th>
                <th>Name</th>
                <th style="width: 120px;">Code</th>
                <th style="width: 140px;">Type</th>
                <th style="width: 110px;">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for s in assigned %}
                <tr>
                  <td>{{ s.id_subject }}</td>
                  <td><b>{{ s.name }}</b></td>
                  <td>{{ s.code }}</td>
                  <td>{{ s.subject_type }}</td>
                  <td>
                    <button class="btn btn-danger" type="button" onclick="removeSubject({{ selected_teacher.id_teacher }}, {{ s.id_subject }})">Remove</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p style="margin:0; color: var(--muted);">No assigned subjects.</p>
        {% endif %}
      </div>

      <div class="card">
        <h3>Available subjects</h3>
        <p style="margin:0 0 10px; color: var(--muted);">
          Add a subject to this teacher.
        </p>

        {% if subjects and subjects|length > 0 %}
          <table class="table">
            <thead>
              <tr>
                <th style="width: 80px;">ID</th>
                <th>Name</th>
                <th style="width: 120px;">Code</th>
                <th style="width: 140px;">Type</th>
                <th style="width: 110px;">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for s in subjects %}
                <tr>
                  <td>{{ s.id_subject }}</td>
                  <td>{{ s.name }}</td>
                  <td>{{ s.code }}</td>
                  <td>{{ s.subject_type }}</td>
                  <td>
                    <button class="btn btn-primary" type="button" onclick="assignSubject({{ s.id_subject }})">Assign</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p style="margin:0; color: var(--muted);">No subjects available.</p>
        {% endif %}

        <div id="resultBox" class="alert alert-error" style="display:none; margin-top:12px;">
          <pre id="result" style="white-space: pre-wrap; margin:0;"></pre>
        </div>
      </div>
    </div>

    <script>
      async function assignSubject(subjectId) {
        const box = document.getElementById("resultBox");
        const out = document.getElementById("result");
        box.style.display = "none";
        out.textContent = "";

        try {
          const resp = await fetch(`/api/teachers/{{ selected_teacher.id_teacher }}/subjects/${subjectId}`, { method: "POST" });
          const text = await resp.text();

          if (resp.ok) {
            window.location.href = `/teacher-subject?teacher_id={{ selected_teacher.id_teacher }}`;
            return;
          }

          box.style.display = "block";
          out.textContent = `Assign failed (${resp.status}): ${text}`;
        } catch (e) {
          box.style.display = "block";
          out.textContent = "Assign failed: " + e;
        }
      }

      async function removeSubject(teacherId, subjectId) {
        const box = document.getElementById("resultBox");
        const out = document.getElementById("result");
        box.style.display = "none";
        out.textContent = "";

        if (!confirm("Remove this subject from the teacher?")) return;

        try {
          const resp = await fetch(`/api/teachers/${teacherId}/subjects/${subjectId}`, { method: "DELETE" });
          const text = await resp.text();

          if (resp.ok) {
            window.location.href = `/teacher-subject?teacher_id={{ selected_teacher.id_teacher }}`;
            return;
          }

          box.style.display = "block";
          out.textContent = `Remove failed (${resp.status}): ${text}`;
        } catch (e) {
          box.style.display = "block";
          out.textContent = "Remove failed: " + e;
        }
      }
    </script>
  {% endif %}

{% endblock %}
